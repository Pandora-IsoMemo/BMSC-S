pipeline {
    agent any
    options { disableConcurrentBuilds() }
    environment {
        CUR_PROJ = 'mpi-constraint-estimation-app' // github repo name
        BASE_IMAGE = 'bmsc-shiny-base:latest'
        CUR_PKG = 'BMSCApp' // r-package name
        CUR_PKG_FOLDER = '.' // defaults to root
        DOCKER_REPO = "isomemodb.com:8081"
    }
    stages {
        stage('Deploy Docker-image') {
            when  { branch 'main' }
            steps {
                sh '''
                docker pull $DOCKER_REPO/$BASE_IMAGE
                docker tag $DOCKER_REPO/$BASE_IMAGE $BASE_IMAGE
                docker build -t $DOCKER_REPO/$CUR_PROJ:latest .
                docker push $DOCKER_REPO/$CUR_PROJ:latest
                docker rmi $DOCKER_REPO/$CUR_PROJ:latest
                docker rmi $BASE_IMAGE
                docker rmi $DOCKER_REPO/$BASE_IMAGE
                '''
            }
        }

        stage('Pull Image on isomemoapp') {
            when { branch 'main' }
            steps {
                sh '''
                ssh mpi-isoapp docker pull $DOCKER_REPO/$CUR_PROJ:latest
                '''
            }
        }

        stage('Deploy Production Docker-image') {
            when  { branch 'depl' }
            steps {
                sh '''
                docker pull $DOCKER_REPO/$BASE_IMAGE
                docker tag $DOCKER_REPO/$BASE_IMAGE $BASE_IMAGE
                docker build -t $DOCKER_REPO/$CUR_PROJ:release .
                docker push $DOCKER_REPO/$CUR_PROJ:release
                docker rmi $DOCKER_REPO/$CUR_PROJ:release
                docker rmi $BASE_IMAGE
                docker rmi $DOCKER_REPO/$BASE_IMAGE
                '''
            }
        }

        stage('Pull Production Image on isomemoapp') {
            when { branch 'depl' }
            steps {
                sh '''
                ssh mpi-isoapp docker pull $DOCKER_REPO/$CUR_PROJ:release
                '''
            }
        }
    }
    post {
        always {
            script {
                if (env.BRANCH_NAME != 'main' && env.BRANCH_NAME != 'depl') {
                    emailext (
                        attachLog: true,
                        body: "Build of job ${env.JOB_NAME} (No. ${env.BUILD_NUMBER}) has completed\n\nBuild status: ${currentBuild.currentResult}\n\n${env.BUILD_URL}\n\nSee attached log file for more details of the build process.",
                        recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']],
                        subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}"
                    )
                }
            }
        }
        failure {
           script {
                if (env.BRANCH_NAME == 'main' || env.BRANCH_NAME == 'depl') {
                    emailext (
                        attachLog: true,
                        body: "Build of job ${env.JOB_NAME} (No. ${env.BUILD_NUMBER}) has completed\n\nBuild status: ${currentBuild.currentResult}\n\n${env.BUILD_URL}\n\nSee attached log file for more details of the build process.",
                        recipientProviders: [[$class: 'DevelopersRecipientProvider'], [$class: 'RequesterRecipientProvider']],
                        to: "andreas.neudecker@inwt-statistics.de,marcus.gross@inwt-statistics.de",
                        subject: "Jenkins Build ${currentBuild.currentResult}: Job ${env.JOB_NAME}"
                    )
                }
            }
        }
    }
}
